# Playtest Report - Story Mode

**Datum:** 2025-12-28
**Zeit:** 17:47 UTC
**Version:** Branch `claude/add-story-mode-OssYn`
**Commit:** 0e71e00

---

## Testumfang

| Test | Phasen | Durchl√§ufe | Dauer |
|------|--------|------------|-------|
| Vollst√§ndiger Playtest | 24 | 1 | 7ms |
| Balance-Test | 48 | 1 | 4ms |
| Konsequenz-Test | 36 | 5 | 13ms |

**Gesamte Aktionen getestet:** 108 geladen
**Gesamte Konsequenzen definiert:** 22 geladen
**NPCs:** 5 geladen

---

## Kritische Probleme (BLOCKER)

### üî¥ BUG-001: Konsequenzen werden NICHT ausgel√∂st
- **Schweregrad:** KRITISCH
- **Beobachtung:** In 8 Testl√§ufen mit insgesamt 252 Phasen wurde KEINE einzige Konsequenz getriggert
- **Erwartung:** ~20-30 Konsequenzen basierend auf Wahrscheinlichkeiten
- **Ursache vermutlich:**
  - `seededRandom()` gibt m√∂glicherweise immer Werte > Wahrscheinlichkeit
  - Oder Action-IDs matchen nicht mit `triggered_by` in consequences.json
- **Datei:** `StoryEngineAdapter.ts` Zeile ~1183 (`registerPotentialConsequences`)

### üî¥ BUG-002: Destabilisierungs-Fortschritt = 0%
- **Schweregrad:** KRITISCH
- **Beobachtung:** Nach 24 Phasen mit 23 Aktionen: Fortschritt 0.0%
- **Erwartung:** Sichtbarer Fortschritt Richtung 40% Ziel
- **Ursache vermutlich:**
  - `trust_erosion` Effekte werden in Aktionen definiert aber nicht angewandt
  - Oder Objective-Tracking ist nicht mit Aktionseffekten verbunden
- **Datei:** `StoryEngineAdapter.ts` Zeile ~1112-1132 (`applyActionEffects`)

### üî¥ BUG-003: Attention bleibt immer 0%
- **Schweregrad:** HOCH
- **Beobachtung:** Attention-Wert √§ndert sich NIE trotz illegaler Aktionen
- **Erwartung:** Attention sollte mit Aktionskosten steigen
- **Ursache vermutlich:**
  - `attention` Kosten werden in `deductActionCosts` nicht verarbeitet
  - Oder decay ist zu aggressiv (5 pro Phase)
- **Datei:** `StoryEngineAdapter.ts` Zeile ~1054-1063

---

## Balance-Probleme

### üü° BAL-001: Budget ersch√∂pft zu schnell
- **Beobachtung:** Budget = 0k‚Ç¨ nach Phase 11 (von 24)
- **Konsequenz:** Spieler kann ~13 Phasen keine Budget-Aktionen mehr ausf√ºhren
- **Vorschlag:**
  - Startbudget erh√∂hen (100 ‚Üí 200)
  - Oder Budget-Regeneration pro Phase (z.B. +5k‚Ç¨)
  - Oder Budgetkosten der Aktionen reduzieren

**Budget-Verlauf:**
```
Phase  1: 100k‚Ç¨
Phase  5:  64k‚Ç¨
Phase 10:   8k‚Ç¨
Phase 11:   0k‚Ç¨ (ersch√∂pft)
Phase 24:  50k‚Ç¨ (nach Jahresbudget-Event)
```

### üü° BAL-002: Risiko eskaliert zu schnell bei aggressivem Spiel
- **Beobachtung:** Risiko 87% nach 48 Phasen ‚Üí Game Over
- **Konsequenz:** Spiel endet zu fr√ºh bei aktivem Spielstil
- **Vorschlag:**
  - Risiko-Decay erh√∂hen (aktuell 0?)
  - Oder Risiko-Kosten der Aktionen reduzieren

**Risiko-Verlauf:**
```
Phase  1:   0%
Phase 10:  20%
Phase 25:  39%
Phase 48:  87% ‚Üí DEFEAT
```

### üü° BAL-003: Welt-Events triggern zu h√§ufig
- **Beobachtung:** "Medienskandal ersch√ºttert Westunion" triggert ~16x in einem Durchlauf
- **Ursache:** `random` Trigger mit 15% Wahrscheinlichkeit nach Phase 6 triggert jede Phase
- **Vorschlag:** Cooldown-System oder `hasTriggered` Flag

---

## Gameplay-Beobachtungen

### Positiv ‚úÖ
- 108 Aktionen laden korrekt
- NPCs initialisieren mit korrekten Werten
- Action-Unlock-System funktioniert (Voraussetzungen werden gepr√ºft)
- Phasen-Fortschritt funktioniert
- Jahresbudget-Event triggert korrekt (Phase 24 ‚Üí +50k‚Ç¨)

### Negativ ‚ùå
- Kein sp√ºrbarer Fortschritt Richtung Spielziel
- Konsequenzen sind effektiv deaktiviert
- Moral-Weight wird kaum erh√∂ht (nur 6 nach 48 Phasen)
- NPCs reagieren nicht sichtbar auf Aktionen (kein Relationship-Progress)

---

## Detaillierte Testergebnisse

### Test 1: Vollst√§ndiger Playtest (24 Phasen)
```
Phases Played: 24
Actions Executed: 23
Consequences Triggered: 0
Game End: ongoing
Final Resources:
  Budget: 50k‚Ç¨ (nach Budget-Event)
  Risk: 39%
  Attention: 0%
  Moral: 0
```

### Test 2: Balance-Test (48 Phasen)
```
Phases Played: 48
Actions Executed: ~45
Consequences Triggered: 0
Game End: DEFEAT (Risk 87%)
```

### Test 3: Konsequenz-Test (5x 36 Phasen)
```
Total Consequences: 0
Average per run: 0.0
```

---

## Reproduktionsschritte

1. `npm run build` ausf√ºhren
2. `npx vitest run src/story-mode/tests/playtest.test.ts` ausf√ºhren
3. Beobachten:
   - Konsequenzen = 0
   - Destabilization Progress = 0%
   - Attention = 0%

---

## Priorisierte Behebungsliste

| # | Bug/Issue | Priorit√§t | Gesch√§tzter Aufwand |
|---|-----------|-----------|---------------------|
| 1 | BUG-001: Konsequenzen triggern nicht | P0 | 2h |
| 2 | BUG-002: Destabilisierung ohne Fortschritt | P0 | 1h |
| 3 | BUG-003: Attention immer 0% | P1 | 30min |
| 4 | BAL-001: Budget ersch√∂pft zu schnell | P1 | 15min |
| 5 | BAL-002: Risiko-Eskalation zu schnell | P2 | 30min |
| 6 | BAL-003: Welt-Events Spam | P2 | 30min |
| 7 | NPC Relationship-Progress fehlt | P2 | 1h |

---

## Root-Cause-Analyse

### BUG-001 Root Cause: `probability.max` ist undefined

**Datei:** `ConsequenceSystem.ts` Zeile 199

```typescript
const maxProbability = def.probability.max;  // undefined!

const probability = Math.min(
  baseProbability + (count - 1) * increasePerUse,
  maxProbability  // Math.min(0.15, undefined) = NaN
);

if (rng() < probability) {  // rng() < NaN = immer false!
```

**JSON-Struktur hat KEIN `max` Feld:**
```json
"probability": {
  "base": 0.15,
  "per_use_increase": 0.05,
  "risk_multiplier": 0.02,
  "attention_multiplier": 0.03
}
```

**Fix:** Default-Wert f√ºr `max` hinzuf√ºgen: `def.probability.max ?? 1.0`

### BUG-001b: seededRandom gibt immer gleichen Wert pro Phase

**Datei:** `StoryEngineAdapter.ts` Zeile 854

```typescript
private seededRandom(seed: string = `phase_${this.storyPhase.number}`): number {
  // Ohne eindeutigen Seed pro Aufruf ‚Üí immer gleicher Wert pro Phase
}
```

**Aufruf ohne Parameter:**
```typescript
const pendingFromSystem = this.consequenceSystem.onActionExecuted(
  action.id,
  this.storyPhase.number,
  () => this.seededRandom()  // Kein eindeutiger Seed!
);
```

**Fix:** Eindeutigen Seed pro Aufruf: `() => this.seededRandom(\`action_${action.id}_${Date.now()}\`)`

---

## Neue Priorit√§tenliste (nach Playtest)

### P0 - KRITISCH (Spiel funktioniert nicht)

| # | Bug | Aufwand | Fix |
|---|-----|---------|-----|
| 1 | Konsequenzen triggern nie (NaN probability) | 5 min | `max ?? 1.0` Default |
| 2 | seededRandom nicht eindeutig | 10 min | Unique seed pro Aufruf |

### P1 - HOCH (Kernmechanik defekt)

| # | Bug/Issue | Aufwand | Fix |
|---|-----------|---------|-----|
| 3 | Destabilisierung ohne Fortschritt | 30 min | trust_erosion ‚Üí Objective |
| 4 | Attention immer 0% | 15 min | Decay reduzieren, Kosten pr√ºfen |
| 5 | Budget ersch√∂pft Phase 11 | 10 min | Startbudget oder Regeneration |

### P2 - MITTEL (Balance)

| # | Issue | Aufwand | Fix |
|---|-------|---------|-----|
| 6 | Risiko-Eskalation zu schnell | 15 min | Risk-Decay oder Kosten |
| 7 | Welt-Events Spam | 15 min | Cooldown/hasTriggered Flag |
| 8 | NPC Relationship-Progress fehlt | 30 min | Relationship in Aktionseffekten |

### P3 - NIEDRIG (Nice-to-have)

| # | Issue | Aufwand |
|---|-------|---------|
| 9 | Moral-Weight zu niedrig | 10 min |
| 10 | Objectives aus JSON laden (TD-007) | 1h |
| 11 | Auto-Save (TD-018) | 30 min |

---

## Testautor

Automatisierter Playtest via `playtest.test.ts`
